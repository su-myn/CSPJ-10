{% extends "base.html" %}

{% block title %}{{ category.name }} - Personal Database{% endblock %}

{% block extra_css %}
<style>
    .entity-card {
        transition: transform 0.2s;
    }
    .entity-card:hover {
        transform: translateY(-5px);
    }
    .tag-badge {
        display: inline-block;
        margin: 2px;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.85em;
    }
    .filter-section {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    .entity-item.draggable {
        cursor: grab;
    }
    .entity-item.draggable:active {
        cursor: grabbing;
    }
    .entity-item.dragging {
        opacity: 0.5;
    }
    .entity-item.drop-target {
        border: 3px dotted #4a6cf7;
    }
    /* Custom 5-column layout for large screens */
    @media (min-width: 992px) {
        #entitiesContainer .col-lg {
            flex: 0 0 20%;
            max-width: 20%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>
        <span id="category-name-display" onclick="editCategoryName()" style="cursor: pointer;" title="Click to edit">
            {{ category.name }}
        </span>
        <input type="text" id="category-name-input" value="{{ category.name }}" class="form-control d-none" style="display: inline-block; width: auto; font-size: inherit; font-weight: inherit; padding: 0.25rem 0.5rem; margin: 0;" onblur="saveCategoryName()" onkeypress="handleCategoryNameKeypress(event)">
    </h1>
    <div>
        <button type="button" class="btn btn-sm btn-outline-primary" id="toggleFilterBtn" onclick="toggleTagFilter()">
            <i class="bi bi-funnel"></i> Show Filter
        </button>
        <a href="/category/{{ category.id }}/entity/new" class="btn btn-primary">Add Entity</a>
        <a href="/category/{{ category.id }}/fields" class="btn btn-secondary">Manage Fields</a>
        <a href="/category/{{ category.id }}/tags" class="btn btn-info">Manage Tags</a>
        <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteCategoryModal">Delete Category</button>
        <a href="/dashboard" class="btn btn-outline-secondary">Back</a>
    </div>
</div>

<!-- Filter and Sort Section -->
<div class="filter-section d-none" id="filterSection">
    <div class="d-flex flex-wrap gap-3 align-items-start" id="tagFilterRow">
        <div style="flex: 0 0 auto; min-width: 200px; max-width: 300px;">
            <label class="form-label">Filter by Tags (select multiple):</label>
            <div class="tag-filter-container" style="max-height: 150px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 4px; padding: 10px; background: white;">
                {% if all_tags %}
                    {% for tag in all_tags %}
                    <div class="form-check">
                        <input class="form-check-input tag-filter-checkbox" type="checkbox" value="{{ tag.id }}" id="tag_{{ tag.id }}" onchange="filterEntities()">
                        <label class="form-check-label" for="tag_{{ tag.id }}" style="cursor: pointer;">
                            <span class="badge" style="background-color: {{ tag.color }}20; color: {{ tag.color }}; border: 1px solid {{ tag.color }}; padding: 4px 8px;">
                                {{ tag.name }}
                            </span>
                        </label>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted small mb-0">No tags available. <a href="/category/{{ category.id }}/tags">Create tags</a> to filter entities.</p>
                {% endif %}
            </div>
            <button type="button" class="btn btn-sm btn-link mt-2 p-0" onclick="clearTagFilters()">Clear all filters</button>
        </div>
        <div style="flex: 0 0 auto; min-width: 150px;">
            <label for="sortBy" class="form-label">Sort By:</label>
            <select class="form-select form-select-sm" id="sortBy" onchange="filterEntities()">
                <option value="display_order">Display Order</option>
                <option value="name">Name</option>
                <option value="created_at">Date Created</option>
                <option value="updated_at">Last Updated</option>
            </select>
        </div>
        <div style="flex: 0 0 auto; min-width: 150px;">
            <label for="sortOrder" class="form-label">Order:</label>
            <select class="form-select form-select-sm" id="sortOrder" onchange="filterEntities()">
                <option value="asc">Ascending</option>
                <option value="desc">Descending</option>
            </select>
        </div>
    </div>
</div>

<!-- Compare Section -->
<div class="mb-3">
    <button class="btn btn-info" onclick="enableCompareMode()">Compare Mode</button>
    <button class="btn btn-success d-none" id="compareBtn" onclick="compareSelected()">Compare Selected (<span id="selectedCount">0</span>)</button>
    <button class="btn btn-secondary d-none" id="cancelCompareBtn" onclick="cancelCompareMode()">Cancel</button>
    <small class="text-muted ms-2 d-none" id="compareHint">Select 1-4 entities to compare</small>
</div>

<div id="entitiesContainer" class="row entity-drop-zone">
    <!-- DEBUG: entities_with_tags count = {{ entities_with_tags|length }} -->
    {% for item in entities_with_tags %}
    <!-- DEBUG: item.entity = {{ item.entity }} -->
    <div class="col-lg col-md-4 col-sm-6 mb-4 entity-item draggable" draggable="true" data-entity-id="{{ item.entity.id }}" data-entity-name="{{ item.entity.name|e }}" data-tag-count="{{ item.tags|length }}">
        <div class="card entity-card h-100">
            <div class="form-check compare-checkbox d-none position-absolute" style="top: 10px; left: 10px; z-index: 10; background: rgba(255,255,255,0.9); padding: 5px; border-radius: 4px;">
                <input class="form-check-input" type="checkbox" value="{{ item.entity.id }}" id="compare_{{ item.entity.id }}">
                <label class="form-check-label" for="compare_{{ item.entity.id }}">Select</label>
            </div>
            
            <!-- Image Section - Display primary image if available -->
            {% if item.primary_image %}
                <a href="/category/{{ category.id }}/entity/{{ item.entity.id }}" style="text-decoration: none; display: block;">
                    <div class="entity-image-container" style="cursor: pointer;">
                        <img src="{{ item.primary_image|thumbnail_url(500) }}" alt="{{ item.entity.name }}" class="entity-card-image" loading="lazy">
                    </div>
                </a>
            {% else %}
                <a href="/category/{{ category.id }}/entity/{{ item.entity.id }}" style="text-decoration: none; display: block;">
                    <div class="entity-image-container" style="cursor: pointer;">
                        <div class="entity-placeholder-image">
                            <i class="bi bi-image" style="font-size: 3rem; color: #dee2e6;"></i>
                        </div>
                    </div>
                </a>
            {% endif %}
            
            <div class="card-body">
                <h5 class="card-title mb-2">{{ item.entity.name }}</h5>
                
                <!-- Other Fields (non-image) -->
                {% if fields %}
                <div class="entity-fields small text-muted">
                    {% for field in fields %}
                        {% if field.field_type != 'image' and field.field_type != 'image_album' %}
                            {% set value = item.field_values.get(field.id, '') if item.field_values else '' %}
                            {% if value %}
                            <div class="mb-1"><strong>{{ field.label }}:</strong> 
                                {% if value|length > 30 %}
                                {{ value[:30] }}...
                                {% else %}
                                {{ value }}
                                {% endif %}
                            </div>
                            {% endif %}
                        {% endif %}
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            
            <div class="card-footer bg-transparent border-top-0">
                <div class="d-grid gap-2">
                    <a href="/category/{{ category.id }}/entity/{{ item.entity.id }}/edit" class="btn btn-sm btn-primary">Edit</a>
                    <button type="button" class="btn btn-sm btn-danger w-100" onclick="openDeleteEntityModal(this)">Delete</button>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

{% if entities_with_tags|length == 0 %}
<div class="alert alert-info">
    <h4>No entities yet!</h4>
    <p>Add your first entity to this category.</p>
    <a href="/category/{{ category.id }}/entity/new" class="btn btn-primary">Add Entity</a>
</div>
{% endif %}

<!-- Delete Category Confirmation Modal -->
<div class="modal fade" id="deleteCategoryModal" tabindex="-1" aria-labelledby="deleteCategoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="/category/{{ category.id }}/delete" id="deleteCategoryForm">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="deleteCategoryModalLabel">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>Delete Category
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="fw-bold text-danger mb-3">This action cannot be undone. The following will be permanently deleted:</p>
                    <ul class="list-group mb-4">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-collection me-2"></i>All entities in this category</span>
                            <span class="badge bg-danger rounded-pill">{{ entities_with_tags|length }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-list-ul me-2"></i>All custom fields</span>
                            <span class="badge bg-danger rounded-pill">{{ fields|length }}</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-tags me-2"></i>All tags</span>
                            <span class="badge bg-danger rounded-pill">{{ all_tags|length }}</span>
                        </li>
                        <li class="list-group-item">
                            <span><i class="bi bi-images me-2"></i>All uploaded images and files</span>
                        </li>
                        <li class="list-group-item">
                            <span><i class="bi bi-database me-2"></i>All field values and entity data</span>
                        </li>
                    </ul>
                    <p class="mb-2">To confirm, type <strong>{{ category.name }}</strong> below:</p>
                    <input type="text" id="deleteCategoryConfirmInput" name="confirm_name" class="form-control" placeholder="Type category name to confirm" autocomplete="off">
                    <div class="invalid-feedback" id="deleteCategoryConfirmError">The name must match exactly.</div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger" id="deleteCategoryConfirmBtn" disabled>
                        <i class="bi bi-trash"></i> Delete Permanently
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Entity Confirmation Modal -->
<div class="modal fade" id="deleteEntityModal" tabindex="-1" aria-labelledby="deleteEntityModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" id="deleteEntityForm">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="deleteEntityModalLabel">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>Delete Entity
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="fw-bold text-danger mb-3">This action cannot be undone. The following will be permanently deleted:</p>
                    <ul class="list-group mb-4">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-box me-2"></i>Entity: <strong id="deleteEntityNameDisplay"></strong></span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-tags me-2"></i>All tags assigned to this entity</span>
                            <span class="badge bg-danger rounded-pill" id="deleteEntityTagCount">0</span>
                        </li>
                        <li class="list-group-item">
                            <span><i class="bi bi-list-ul me-2"></i>All field values and custom data</span>
                        </li>
                        <li class="list-group-item">
                            <span><i class="bi bi-images me-2"></i>All uploaded images and files</span>
                        </li>
                    </ul>
                    <p class="mb-2">To confirm, type <strong id="deleteEntityNameConfirm"></strong> below:</p>
                    <input type="text" id="deleteEntityConfirmInput" name="confirm_name" class="form-control" placeholder="Type entity name to confirm" autocomplete="off">
                    <div class="invalid-feedback" id="deleteEntityConfirmError">The name must match exactly.</div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger" id="deleteEntityConfirmBtn" disabled>
                        <i class="bi bi-trash"></i> Delete Permanently
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let compareMode = false;
const categoryId = {{ category.id }};
const categoryNameToConfirm = {{ category.name|tojson }};
let pageLoaded = false;

// Delete category confirmation - enable button when name matches
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('deleteCategoryModal');
    const confirmInput = document.getElementById('deleteCategoryConfirmInput');
    const confirmBtn = document.getElementById('deleteCategoryConfirmBtn');
    const confirmError = document.getElementById('deleteCategoryConfirmError');
    
    if (modal && confirmInput && confirmBtn) {
        confirmInput.addEventListener('input', function() {
            const matches = confirmInput.value.trim() === categoryNameToConfirm;
            confirmBtn.disabled = !matches;
            confirmInput.classList.toggle('is-invalid', confirmInput.value.trim() !== '' && !matches);
            confirmError.style.display = matches || confirmInput.value.trim() === '' ? 'none' : 'block';
        });
        
        modal.addEventListener('show.bs.modal', function() {
            confirmInput.value = '';
            confirmBtn.disabled = true;
            confirmInput.classList.remove('is-invalid');
            confirmError.style.display = 'none';
        });
        
        document.getElementById('deleteCategoryForm').addEventListener('submit', function(e) {
            if (confirmInput.value.trim() !== categoryNameToConfirm) {
                e.preventDefault();
                confirmInput.classList.add('is-invalid');
                confirmError.style.display = 'block';
            }
        });
    }
});

function openDeleteEntityModal(btn) {
    const entityItem = btn.closest('.entity-item');
    if (!entityItem) return;
    const entityId = entityItem.dataset.entityId;
    const entityName = entityItem.dataset.entityName || '';
    const tagCount = entityItem.dataset.tagCount || '0';
    
    const form = document.getElementById('deleteEntityForm');
    form.action = '/category/' + categoryId + '/entity/' + entityId + '/delete';
    
    document.getElementById('deleteEntityNameDisplay').textContent = entityName;
    document.getElementById('deleteEntityNameConfirm').textContent = entityName;
    document.getElementById('deleteEntityTagCount').textContent = tagCount;
    
    const confirmInput = document.getElementById('deleteEntityConfirmInput');
    const confirmBtn = document.getElementById('deleteEntityConfirmBtn');
    const confirmError = document.getElementById('deleteEntityConfirmError');
    
    confirmInput.value = '';
    confirmBtn.disabled = true;
    confirmInput.classList.remove('is-invalid');
    confirmError.style.display = 'none';
    
    const modal = new bootstrap.Modal(document.getElementById('deleteEntityModal'));
    modal.show();
    
    const checkMatch = function() {
        const matches = confirmInput.value.trim() === entityName;
        confirmBtn.disabled = !matches;
        confirmInput.classList.toggle('is-invalid', confirmInput.value.trim() !== '' && !matches);
        confirmError.style.display = matches || confirmInput.value.trim() === '' ? 'none' : 'block';
    };
    
    confirmInput.oninput = checkMatch;
    form.onsubmit = function(e) {
        if (confirmInput.value.trim() !== entityName) {
            e.preventDefault();
            confirmInput.classList.add('is-invalid');
            confirmError.style.display = 'block';
        }
    };
}

document.addEventListener('DOMContentLoaded', function() {
    const deleteEntityModal = document.getElementById('deleteEntityModal');
    if (deleteEntityModal) {
        deleteEntityModal.addEventListener('show.bs.modal', function() {
            document.getElementById('deleteEntityConfirmInput').value = '';
            document.getElementById('deleteEntityConfirmBtn').disabled = true;
            document.getElementById('deleteEntityConfirmInput').classList.remove('is-invalid');
            document.getElementById('deleteEntityConfirmError').style.display = 'none';
        });
    }
});

// Prevent filterEntities from running on page load
document.addEventListener('DOMContentLoaded', function() {
    // Small delay to ensure page is fully loaded
    setTimeout(function() {
        pageLoaded = true;
    }, 100);
    setupEntityDragDrop();
});

function setupEntityDragDrop() {
    const container = document.getElementById('entitiesContainer');
    if (!container) return;
    
    const entityItems = container.querySelectorAll('.entity-item.draggable');
    const sortBy = document.getElementById('sortBy');
    const checkedTags = document.querySelectorAll('.tag-filter-checkbox:checked');
    const canReorder = (!sortBy || sortBy.value === 'display_order') && checkedTags.length === 0;
    
    if (!canReorder || entityItems.length === 0) return;
    
    entityItems.forEach(function(item) {
        item.removeEventListener('dragstart', handleEntityDragStart);
        item.removeEventListener('dragend', handleEntityDragEnd);
        item.addEventListener('dragstart', handleEntityDragStart);
        item.addEventListener('dragend', handleEntityDragEnd);
    });
    
    container.removeEventListener('dragover', handleEntityDragOver);
    container.removeEventListener('dragleave', handleEntityDragLeave);
    container.removeEventListener('drop', handleEntityDrop);
    container.addEventListener('dragover', handleEntityDragOver);
    container.addEventListener('dragleave', handleEntityDragLeave);
    container.addEventListener('drop', handleEntityDrop);
}

function handleEntityDragStart(e) {
    e.dataTransfer.setData('entityId', e.currentTarget.dataset.entityId);
    e.currentTarget.classList.add('dragging');
}

function handleEntityDragEnd(e) {
    e.currentTarget.classList.remove('dragging');
    document.querySelectorAll('.entity-item.drop-target').forEach(function(el) { el.classList.remove('drop-target'); });
}

function handleEntityDragOver(e) {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'move';
    const targetItem = e.target.closest('.entity-item.draggable');
    document.querySelectorAll('.entity-item.drop-target').forEach(function(el) { el.classList.remove('drop-target'); });
    if (targetItem) targetItem.classList.add('drop-target');
}

function handleEntityDragLeave(e) {
    if (!e.currentTarget.contains(e.relatedTarget)) {
        document.querySelectorAll('.entity-item.drop-target').forEach(function(el) { el.classList.remove('drop-target'); });
    }
}

function handleEntityDrop(e) {
    e.preventDefault();
    document.querySelectorAll('.entity-item.drop-target').forEach(function(el) { el.classList.remove('drop-target'); });
    
    const entityId = e.dataTransfer.getData('entityId');
    const targetItem = e.target.closest('.entity-item.draggable');
    if (!entityId) return;
    
    const container = document.getElementById('entitiesContainer');
    const items = Array.from(container.querySelectorAll('.entity-item.draggable'));
    let orderedIds = items.map(function(el) { return el.dataset.entityId; });
    const draggedIdx = orderedIds.indexOf(entityId);
    if (draggedIdx === -1) return;
    
    orderedIds.splice(draggedIdx, 1);
    if (targetItem && targetItem.dataset.entityId !== entityId) {
        const targetIdx = orderedIds.indexOf(targetItem.dataset.entityId);
        if (targetIdx !== -1) orderedIds.splice(targetIdx, 0, entityId);
        else orderedIds.push(entityId);
    } else {
        orderedIds.push(entityId);
    }
    
    const formData = new FormData();
    orderedIds.forEach(function(id) { formData.append('entity_ids', id); });
    
    fetch('/category/' + categoryId + '/entity/reorder', {
        method: 'POST',
        body: formData
    })
    .then(function() { window.location.reload(); })
    .catch(function() { window.location.reload(); });
}

function enableCompareMode() {
    compareMode = true;
    document.querySelectorAll('.compare-checkbox').forEach(cb => cb.classList.remove('d-none'));
    document.getElementById('compareBtn').classList.remove('d-none');
    document.getElementById('cancelCompareBtn').classList.remove('d-none');
    document.getElementById('compareHint').classList.remove('d-none');
    updateSelectedCount();
    
    // Add event listeners to checkboxes to update count
    document.querySelectorAll('.compare-checkbox input').forEach(cb => {
        cb.addEventListener('change', updateSelectedCount);
    });
}

function updateSelectedCount() {
    const checked = document.querySelectorAll('.compare-checkbox input:checked').length;
    document.getElementById('selectedCount').textContent = checked;
    const compareBtn = document.getElementById('compareBtn');
    if (checked >= 1 && checked <= 4) {
        compareBtn.disabled = false;
        compareBtn.classList.remove('btn-secondary');
        compareBtn.classList.add('btn-success');
    } else {
        compareBtn.disabled = true;
        compareBtn.classList.remove('btn-success');
        compareBtn.classList.add('btn-secondary');
    }
}

function cancelCompareMode() {
    compareMode = false;
    document.querySelectorAll('.compare-checkbox').forEach(cb => {
        cb.classList.add('d-none');
        cb.querySelector('input').checked = false;
    });
    document.getElementById('compareBtn').classList.add('d-none');
    document.getElementById('cancelCompareBtn').classList.add('d-none');
    document.getElementById('compareHint').classList.add('d-none');
    
    // Remove event listeners
    document.querySelectorAll('.compare-checkbox input').forEach(cb => {
        cb.removeEventListener('change', updateSelectedCount);
    });
}

function compareSelected() {
    const checked = Array.from(document.querySelectorAll('.compare-checkbox input:checked'));
    if (checked.length < 1 || checked.length > 4) {
        alert('Please select 1 to 4 entities to compare');
        return;
    }
    // Build query string with entity IDs
    const params = checked.map((cb, index) => `entity${index + 1}=${cb.value}`).join('&');
    window.location.href = `/category/${categoryId}/compare?${params}`;
}

function toggleTagFilter() {
    const filterSection = document.getElementById('filterSection');
    const filterRow = document.getElementById('tagFilterRow');
    const toggleBtn = document.getElementById('toggleFilterBtn');
    
    if (!filterSection || !filterRow || !toggleBtn) {
        console.error('Filter elements not found');
        return;
    }
    
    if (filterSection.classList.contains('d-none')) {
        filterSection.classList.remove('d-none');
        toggleBtn.innerHTML = '<i class="bi bi-funnel-fill"></i> Hide Filter';
    } else {
        filterSection.classList.add('d-none');
        toggleBtn.innerHTML = '<i class="bi bi-funnel"></i> Show Filter';
    }
}

function clearTagFilters() {
    document.querySelectorAll('.tag-filter-checkbox').forEach(cb => {
        cb.checked = false;
    });
    filterEntities();
}

function filterEntities() {
    // Don't run on initial page load - only when user explicitly changes filters
    if (!pageLoaded) {
        return;
    }
    
    // Get all checked tag IDs
    const checkedTags = Array.from(document.querySelectorAll('.tag-filter-checkbox:checked'))
        .map(cb => cb.value);
    const tagFilter = checkedTags.length > 0 ? checkedTags.join(',') : '';
    const sortBy = document.getElementById('sortBy').value;
    const sortOrder = document.getElementById('sortOrder').value;
    const canReorder = checkedTags.length === 0 && sortBy === 'display_order';
    
    fetch(`/api/category/${categoryId}/entities?tags=${tagFilter}&sort=${sortBy}&order=${sortOrder}`)
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('entitiesContainer');
            container.innerHTML = '';
            
            if (data.length === 0) {
                container.innerHTML = '<div class="col-12"><div class="alert alert-info">No entities found matching the filter.</div></div>';
                return;
            }
            
            data.forEach(item => {
                // Generate image HTML - show image if available, otherwise placeholder
                let imageHtml = '';
                if (item.primary_image) {
                    const baseName = item.primary_image.replace(/\.[^/.]+$/, '');
                    const thumbUrl = `/static/uploads/thumbnails/${baseName}_thumb500.jpg`;
                    const fullUrl = `/static/uploads/${item.primary_image}`;
                    imageHtml = `<a href="/category/${categoryId}/entity/${item.id}" style="text-decoration: none; display: block;">
                        <div class="entity-image-container" style="cursor: pointer;">
                            <img src="${thumbUrl}" alt="${item.name}" class="entity-card-image" onerror="this.onerror=null; this.src='${fullUrl}'">
                        </div>
                    </a>`;
                } else {
                    imageHtml = `<a href="/category/${categoryId}/entity/${item.id}" style="text-decoration: none; display: block;">
                        <div class="entity-image-container" style="cursor: pointer;">
                            <div class="entity-placeholder-image">
                                <i class="bi bi-image" style="font-size: 3rem; color: #dee2e6;"></i>
                            </div>
                        </div>
                    </a>`;
                }
                
                const dragAttrs = canReorder ? ' draggable="true" class="col-lg col-md-4 col-sm-6 mb-4 entity-item draggable"' : ' class="col-lg col-md-4 col-sm-6 mb-4 entity-item"';
                const tagCount = item.tags ? item.tags.length : 0;
                const entityNameEscaped = (item.name || '').replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                const card = `
                    <div${dragAttrs} data-entity-id="${item.id}" data-entity-name="${entityNameEscaped}" data-tag-count="${tagCount}">
                        <div class="card entity-card h-100">
                            <div class="form-check compare-checkbox ${compareMode ? '' : 'd-none'} position-absolute" style="top: 10px; left: 10px; z-index: 10; background: rgba(255,255,255,0.9); padding: 5px; border-radius: 4px;">
                                <input class="form-check-input" type="checkbox" value="${item.id}" id="compare_${item.id}" onchange="updateSelectedCount()">
                                <label class="form-check-label" for="compare_${item.id}">Select</label>
                            </div>
                            ${imageHtml}
                            <div class="card-body">
                                <h5 class="card-title mb-2">${item.name}</h5>
                            </div>
                            <div class="card-footer bg-transparent border-top-0">
                                <div class="d-grid gap-2">
                                    <a href="/category/${categoryId}/entity/${item.id}/edit" class="btn btn-sm btn-primary">Edit</a>
                                    <button type="button" class="btn btn-sm btn-danger w-100" onclick="openDeleteEntityModal(this)">Delete</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += card;
            });
            
            // Update selected count after filtering if in compare mode
            if (compareMode) {
                updateSelectedCount();
            }
            setupEntityDragDrop();
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error filtering entities');
        });
}

function editCategoryName() {
    const display = document.getElementById('category-name-display');
    const input = document.getElementById('category-name-input');
    
    display.classList.add('d-none');
    input.classList.remove('d-none');
    input.focus();
    input.select();
}

function saveCategoryName() {
    const display = document.getElementById('category-name-display');
    const input = document.getElementById('category-name-input');
    const newName = input.value.trim();
    
    if (!newName) {
        input.value = display.textContent.trim();
        input.classList.add('d-none');
        display.classList.remove('d-none');
        return;
    }
    
    // Update display immediately
    display.textContent = newName;
    display.classList.remove('d-none');
    input.classList.add('d-none');
    
    // Save to server
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = `/category/{{ category.id }}/update`;
    
    const nameInput = document.createElement('input');
    nameInput.type = 'hidden';
    nameInput.name = 'name';
    nameInput.value = newName;
    form.appendChild(nameInput);
    
    document.body.appendChild(form);
    form.submit();
}

function handleCategoryNameKeypress(event) {
    if (event.key === 'Enter') {
        event.preventDefault();
        document.getElementById('category-name-input').blur();
    } else if (event.key === 'Escape') {
        event.preventDefault();
        const display = document.getElementById('category-name-display');
        const input = document.getElementById('category-name-input');
        input.value = display.textContent.trim();
        input.classList.add('d-none');
        display.classList.remove('d-none');
    }
}
</script>
{% endblock %}

