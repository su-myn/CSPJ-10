{% extends "base.html" %}

{% block title %}View Entity - {{ category.name }}{% endblock %}

{% block content %}
<div class="row justify-content-center mb-4">
    <div class="col-md-10 col-lg-8">
        <div class="d-flex justify-content-between align-items-center">
            <h1 class="mb-0">{{ entity.name }}</h1>
            <div>
                <a href="/category/{{ category.id }}/entity/{{ entity.id }}/edit" class="btn btn-primary">Edit</a>
                <a href="/category/{{ category.id }}" class="btn btn-secondary">Back</a>
            </div>
        </div>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-md-10 col-lg-8">
        <div class="card">
            <div class="card-body">
                {% if fields %}
                <h5 class="mb-4">Details</h5>
                {% for field in fields %}
                <div class="mb-4">
                    <label class="form-label fw-bold text-muted" style="font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.5px;">
                        {{ field.label }}
                    </label>
                    
                    {% set current_value = field_values.get(field.id, '') %}
                    
                    {% if field.field_type == 'text' or field.field_type == 'email' or field.field_type == 'integer' or field.field_type == 'number' %}
                    <div class="field-value" style="font-size: 1.1em; color: #212529;">
                        {{ current_value if current_value else '<span class="text-muted">Not set</span>'|safe }}
                    </div>
                    
                    {% elif field.field_type == 'textarea' %}
                    <div class="field-value" style="font-size: 1.1em; color: #212529; white-space: pre-line; word-wrap: break-word; padding: 0; margin: 0;">
                        {{ current_value if current_value else '<span class="text-muted">Not set</span>'|safe }}
                    </div>
                    
                    {% elif field.field_type == 'note' %}
                    <div class="field-value" style="font-size: 1.1em; color: #212529; white-space: pre-line; word-wrap: break-word; padding: 0; margin: 0;">
                        {{ current_value if current_value else '<span class="text-muted">No notes</span>'|safe }}
                    </div>
                    
                    {% elif field.field_type == 'datetime' %}
                    <div class="field-value" style="font-size: 1.1em; color: #212529;">
                        {{ current_value if current_value else '<span class="text-muted">Not set</span>'|safe }}
                    </div>
                    
                    {% elif field.field_type == 'select' or field.field_type == 'radio' %}
                    <div class="field-value" style="font-size: 1.1em; color: #212529;">
                        {{ current_value if current_value else '<span class="text-muted">Not set</span>'|safe }}
                    </div>
                    
                    {% elif field.field_type == 'checkbox' %}
                    <div class="field-value" style="font-size: 1.1em; color: #212529;">
                        {% if current_value == 'Yes' %}
                        <span class="badge bg-success">Yes</span>
                        {% else %}
                        <span class="text-muted">No</span>
                        {% endif %}
                    </div>
                    
                    {% elif field.field_type == 'checkbox_list' %}
                    <div class="field-value" style="font-size: 1.1em; color: #212529;">
                        {% if current_value %}
                        {% set selected_values = current_value.split(',') %}
                        {% for val in selected_values %}
                        {% if val.strip() %}
                        <span class="badge bg-primary me-2">{{ val.strip() }}</span>
                        {% endif %}
                        {% endfor %}
                        {% if not selected_values or selected_values|join('')|trim == '' %}
                        <span class="text-muted">No selections</span>
                        {% endif %}
                        {% else %}
                        <span class="text-muted">No selections</span>
                        {% endif %}
                    </div>
                    
                    {% elif field.field_type == 'image' %}
                    <div class="field-value text-center">
                        {% if current_value %}
                        <img src="{{ url_for('static', filename='uploads/' + current_value) }}" alt="{{ field.label }}" class="img-fluid rounded" style="max-width: 100%; max-height: 600px; object-fit: contain;" loading="lazy">
                        {% else %}
                        <span class="text-muted">No image</span>
                        {% endif %}
                    </div>
                    
                    {% elif field.field_type == 'image_album' %}
                    <div class="field-value">
                        {% if current_value %}
                        {% set image_list = current_value|from_json if current_value else [] %}
                        {% if image_list %}
                        <div class="image-album-container" data-album-images='{{ image_list|tojson }}'>
                            {% for img_filename in image_list %}
                            <div class="image-album-item">
                                <img src="{{ img_filename|thumbnail_url(100) }}" alt="{{ field.label }}" class="img-fluid rounded image-album-img" data-bs-toggle="modal" data-bs-target="#imageModal" data-image-src="{{ url_for('static', filename='uploads/' + img_filename) }}" data-image-index="{{ loop.index0 }}" onclick="showImageModal(this)" loading="lazy">
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <span class="text-muted">No images</span>
                        {% endif %}
                        {% else %}
                        <span class="text-muted">No images</span>
                        {% endif %}
                    </div>
                    
                    {% elif field.field_type == 'video_embed' %}
                    <div class="field-value">
                        {% if current_value %}
                        {% set video_list = current_value|from_json if current_value else [] %}
                        {% if video_list %}
                        <div class="video-embed-container" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 20px;">
                            {% for embed_url in video_list %}
                            <div class="video-embed-item" style="position: relative;">
                                <div class="ratio ratio-16x9">
                                    <iframe src="{{ embed_url }}" allowfullscreen frameborder="0" style="width: 100%; height: 100%;"></iframe>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <span class="text-muted">No videos</span>
                        {% endif %}
                        {% else %}
                        <span class="text-muted">No videos</span>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
                <hr>
                {% endfor %}
                {% endif %}
                
                {% if tags %}
                <div class="mb-3">
                    <label class="form-label fw-bold text-muted" style="font-size: 0.9em; text-transform: uppercase; letter-spacing: 0.5px;">Tags</label>
                    <div>
                        {% for tag in tags %}
                        <span class="badge me-2" style="background-color: {{ tag.color }}20; color: {{ tag.color }}; border: 1px solid {{ tag.color }}; padding: 6px 12px; font-size: 0.9em;">
                            {{ tag.name }}
                        </span>
                        {% endfor %}
                        {% if not tags %}
                        <span class="text-muted">No tags</span>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Image Modal -->
<div class="modal fade" id="imageModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalImageTitle">Image</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center position-relative" style="min-height: 400px;">
                <button type="button" class="btn btn-outline-light position-absolute start-0 top-50 translate-middle-y ms-2" id="prevImageBtn" style="z-index: 10; display: none;" onclick="navigateImage(-1)">
                    <i class="bi bi-chevron-left" style="font-size: 2rem;"></i>
                </button>
                <img id="modalImage" src="" alt="Image" class="img-fluid" style="max-height: 70vh;">
                <button type="button" class="btn btn-outline-light position-absolute end-0 top-50 translate-middle-y me-2" id="nextImageBtn" style="z-index: 10; display: none;" onclick="navigateImage(1)">
                    <i class="bi bi-chevron-right" style="font-size: 2rem;"></i>
                </button>
            </div>
        </div>
    </div>
</div>

{% block extra_css %}
<style>
    /* Image modal navigation buttons */
    #prevImageBtn, #nextImageBtn {
        background-color: rgba(0, 0, 0, 0.5);
        border: 2px solid rgba(255, 255, 255, 0.8);
        border-radius: 50%;
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }
    #prevImageBtn:hover, #nextImageBtn:hover {
        background-color: rgba(0, 0, 0, 0.7);
        border-color: rgba(255, 255, 255, 1);
        transform: scale(1.1);
    }
    #prevImageBtn i, #nextImageBtn i {
        color: white;
    }
</style>
{% endblock %}

<script>
// Image modal navigation variables
let currentImageList = [];
let currentImageIndex = 0;

// Image modal function
function showImageModal(imgElement) {
    const imageSrc = imgElement.getAttribute('data-image-src');
    const imageIndex = parseInt(imgElement.getAttribute('data-image-index'));
    
    // Find the album container and get all images
    const albumContainer = imgElement.closest('.image-album-container');
    if (albumContainer) {
        const albumImagesJson = albumContainer.getAttribute('data-album-images');
        if (albumImagesJson) {
            try {
                currentImageList = JSON.parse(albumImagesJson);
                currentImageIndex = imageIndex;
                
                // Convert to full URLs
                currentImageList = currentImageList.map(filename => 
                    '/static/uploads/' + filename
                );
                
                updateModalImage();
            } catch (e) {
                console.error('Error parsing album images:', e);
                // Fallback to single image
                currentImageList = [imageSrc];
                currentImageIndex = 0;
                updateModalImage();
            }
        } else {
            // Fallback if no album data
            currentImageList = [imageSrc];
            currentImageIndex = 0;
            updateModalImage();
        }
    } else {
        // Fallback if no container found
        currentImageList = [imageSrc];
        currentImageIndex = 0;
        updateModalImage();
    }
}

// Update modal image display
function updateModalImage() {
    const modalImage = document.getElementById('modalImage');
    const modalTitle = document.getElementById('modalImageTitle');
    const prevBtn = document.getElementById('prevImageBtn');
    const nextBtn = document.getElementById('nextImageBtn');
    
    if (currentImageList.length > 0 && currentImageIndex >= 0 && currentImageIndex < currentImageList.length) {
        modalImage.src = currentImageList[currentImageIndex];
        modalTitle.textContent = `Image ${currentImageIndex + 1} of ${currentImageList.length}`;
        
        // Show/hide navigation buttons
        if (currentImageList.length > 1) {
            prevBtn.style.display = currentImageIndex > 0 ? 'block' : 'none';
            nextBtn.style.display = currentImageIndex < currentImageList.length - 1 ? 'block' : 'none';
        } else {
            prevBtn.style.display = 'none';
            nextBtn.style.display = 'none';
        }
    }
}

// Navigate to previous/next image
function navigateImage(direction) {
    if (currentImageList.length === 0) return;
    
    currentImageIndex += direction;
    
    // Don't wrap, just clamp
    if (currentImageIndex < 0) {
        currentImageIndex = 0;
    } else if (currentImageIndex >= currentImageList.length) {
        currentImageIndex = currentImageList.length - 1;
    }
    
    updateModalImage();
}

// Keyboard navigation
document.addEventListener('keydown', function(e) {
    const modal = document.getElementById('imageModal');
    if (modal && modal.classList.contains('show')) {
        if (e.key === 'ArrowLeft') {
            e.preventDefault();
            navigateImage(-1);
        } else if (e.key === 'ArrowRight') {
            e.preventDefault();
            navigateImage(1);
        } else if (e.key === 'Escape') {
            // Bootstrap modal handles Escape by default, but we can ensure it works
            const bsModal = bootstrap.Modal.getInstance(modal);
            if (bsModal) {
                bsModal.hide();
            }
        }
    }
});
</script>
{% endblock %}

